name: CI

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black bandit
    
    - name: Check code formatting with Black
      run: black --check --diff . || echo "::warning::Code formatting issues found. Run 'black .' to fix."
      continue-on-error: true
    
    - name: Lint with Flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: Security check with Bandit
      run: bandit -r . -ll
      continue-on-error: true

  javascript-quality:
    name: JavaScript Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install linting tools
      run: npm install --save-dev eslint prettier
    
    - name: Lint JavaScript files
      run: npx eslint *.js --max-warnings 50 || echo "::warning::ESLint found issues"
      continue-on-error: true
    
    - name: Check formatting with Prettier
      run: npx prettier --check "*.js" || echo "::warning::Prettier found formatting issues"
      continue-on-error: true

  docker-validate:
    name: Validate Docker Configuration
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate Docker Compose
      run: docker-compose config
    
    - name: Lint Dockerfiles
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile.nexus
        no-fail: true
    
    - name: Lint Dockerfile.aria
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile.aria
        no-fail: true

  test-build:
    name: Test Build Process
    runs-on: ubuntu-latest
    needs: [python-quality, javascript-quality]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt || echo "Some optional packages failed, continuing..."
    
    - name: Check Python syntax
      run: |
        python -m py_compile nexus_agi.py
        python -m py_compile nexus_service.py
    
    - name: Check JavaScript syntax
      run: |
        node --check aria.js
        node --check aria_service.js

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Python security scan
      run: |
        pip install safety
        pip install -r requirements.txt || true
        safety check --json || echo "::warning::Python security issues found"
      continue-on-error: true
    
    - name: JavaScript security scan
      run: |
        npm audit --json || echo "::warning::JavaScript security issues found"
      continue-on-error: true

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [python-quality, javascript-quality, docker-validate, test-build, security-scan]
    if: always()
    
    steps:
    - name: Check CI status
      run: |
        if [[ "${{ needs.test-build.result }}" == "success" ]]; then
          echo "✅ All critical checks passed"
          exit 0
        else
          echo "❌ Critical checks failed"
          exit 1
        fi
